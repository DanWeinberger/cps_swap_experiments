---
title: "Growth data"
author: "Dan Weinberger"
date: '2023-03-24'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(dplyr)
library(ggplot2)
library(purrr)
library(readxl)
library(patchwork)
library(reshape2)
library(plotly)
library(MASS)
```

Read in the data

```{r}

a1a <- read_xlsx('./Data/Final Growth Curve Summary Data (101723).xlsx', sheet='15BC Summary', skip=1)

a1b <- read_xlsx('./Data/Final Growth Curve Summary Data (101723).xlsx', sheet='22F Summary')

a1c <- read_xlsx('./Data/Final Growth Curve Summary Data (101723).xlsx', sheet='Donors Summary') %>%
  mutate(Background=Serotype)

a1 <- bind_rows(a1a,a1b,a1c) %>%
  mutate(Serotype=gsub('\u2206cps', 'deltacps', Serotype),
         Background = if_else(Serotype %in% c('22Fdeltacps','22Fwt'), '22F', Background),
         )

#e1 <- read_xlsx('./Data/Growth_Curve_Summary_Data_V2a.xlsx', sheet='ELISA analysis')
```

```{r}
names(a1)
```

reshape to long format
```{r}
a1.m <- reshape2::melt(a1, id.vars=c('ID','Serotype','Background','Clone_N','Rep')) %>%
  arrange(ID,Background, Serotype, Clone_N,Rep, variable) %>%
  group_by(ID,Background, Serotype, Clone_N,Rep) %>%
  mutate( index= row_number() -1,  
          t= index/2,
          t0=min(value, na.rm=T),
          #OD= value - t0,
          OD=if_else(value>=0, value, 0),
          ID2 = paste(ID, Rep, sep='_'),
          Serotype= if_else(Serotype=='8C','18C',Serotype ),
          Serotype= if_else(Serotype=='15B/C','15BC',Serotype ),
          Serotype= if_else(Serotype=='9A','19A',Serotype ))  %>%
     mutate( Strain_cat = if_else( grepl("22F_1\\(", ID), 'Donor'  ,
                                if_else( grepl("15BC_15BC_1\\(", ID), '15BC'  ,
                               if_else( grepl("15BC_1\\(", ID), 'Donor'  ,
                                if_else(Background=='15BC', '15BC',
                                  if_else(Background=='22F', '22F', 
                                    if_else(Serotype==Background , 'Donor','Other'))))))) %>%
  filter(t<=21) %>% 
  ungroup()
```


Group by Background, color by Serotype

```{r}

p1 <- a1.m %>%
   filter(Background %in% c('15BC','22F')) %>%
 ggplot( aes(x=t, y=OD, group=ID2, color=Serotype)) +
  geom_line()+
  theme_classic() +
  facet_wrap(~Background)

p1

ggplotly(p1)
```
Group by Serotype, color by Background

```{r}

p1 <- a1.m %>%
   filter(Background %in% c('15BC','22F')) %>%
 ggplot( aes(x=t, y=OD, group=ID2, color=Background)) +
  geom_line()+
  theme_classic() +
  facet_wrap(~Serotype)

p1
```

subset
```{r, fig.width=14, fig.height=8}

 a1.m %>%
   filter(Background %in% c('15BC','22F')) %>%
  filter( Serotype %in% c( '14', '15BC','16F','18C','19A','23A','24F','35B','35F','3','6C','7C','7F','8','9V')) %>%
 ggplot( aes(x=t, y=OD, group=ID2, color=Strain_cat)) +
  geom_line()+
  theme_classic() +
  facet_wrap(~Serotype, ncol=5)+
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=14,face="bold"))+
  theme(strip.text.x = element_text(size = 12))

```

subset, show donors
```{r, fig.width=14, fig.height=8}

 a1.m %>%
   filter(Serotype==Background | Background %in% c('15BC','22F')) %>%
 ggplot( aes(x=t, y=OD, group=ID2, color=Strain_cat)) +
  geom_line()+
  theme_classic() +
  facet_wrap(~Serotype, ncol=5)+
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=14,face="bold"))+
  theme(strip.text.x = element_text(size = 12))

```

## Calculate Max OD

```{r}
max.od <- a1.m %>%
    group_by(ID2,Background, Serotype, Clone_N,Rep) %>%
    summarize( max_od=max(OD, na.rm=T)) %>%
  mutate(Clone_N=as.factor(Clone_N)) 

max.od
```

```{r}
max.od %>%
     filter(Background %in% c('15BC','22F')) %>%
ggplot( aes(x=Serotype, y=max_od,color=Background, shape=Clone_N))+
  geom_point(alpha=0.5)+
  theme_classic()+
       theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```



Smooth with a spline

```{r}
smooth.func<-function(x, cont.correct){
  smooth.mod<-smooth.spline((x[!is.na(x)]), spar=0.5)
  ODsm= smooth.mod$y
  deriv = predict(smooth.mod, deriv=1)$y
  deriv2 = predict(smooth.mod, deriv=2)$y

  out.df= cbind.data.frame('ODsm'=ODsm,'deriv'=deriv,'deriv2'=deriv2)
  return(out.df)
}


a2 <- a1.m %>%
    group_by(ID,Background, Serotype, Clone_N,Rep,Strain_cat) %>%
  filter(!is.na(OD)) %>%
    mutate(smoothvals = smooth.func(OD) ) %>%
tidyr::unpack(., cols=smoothvals)


p1 <- ggplot(a1.m, aes(x=t, y=OD, group=ID2, color=Strain_cat)) +
  geom_line()+
  geom_line(data=a2,aes(x=t, y=ODsm, group=ID2),color='gray')+
  theme_classic() +
  facet_wrap(~Serotype)

p1
```

Plot of smoothed values
```{r}
p1 <- ggplot(a2, aes(x=t, y=(ODsm), group=ID2, color=Strain_cat)) +
  geom_line()+
  theme_classic() +
  facet_wrap(~Background)+
  ggtitle('OD')

ggplotly(p1)
```

Plot of derivatives. When derivative is at max, this shows when growth rate maxes out
```{r}
p2 <- ggplot(a2, aes(x=t, y=deriv, group=ID2, color=Serotype)) +
  geom_line()+
  theme_classic() +
  facet_wrap(~Background)+
  ggtitle('Growth rate')

ggplotly(p2)
```


Plot of derivatives. When derivative is at max, this shows when growth rate maxes out
```{r}
p3 <- ggplot(a2, aes(x=t, y=deriv2, group=ID2, color=Serotype)) +
  geom_line()+
  theme_classic() +
  facet_wrap(~Background)+
  ggtitle('Change in growth rate')

ggplotly(p3)
```

```{r}
p1/p2
```

At what time point does max growth occur?
```{r}
max.deriv.time <- a2 %>%
    group_by(ID2,Background, Serotype, Clone_N,Rep) %>%
   summarize( t_max_deriv = t[which(deriv==max(deriv, na.rm=T)) ], max_deriv=max(deriv, na.rm=T) ) %>%
  mutate(label= paste(Background, Serotype ))
  max.deriv.time
  
  ggplot(max.deriv.time , aes(x=label, y=t_max_deriv))+
    geom_jitter(width=0.1, height=0, alpha=0.5)+
    theme_classic() +
    ylab('Time of max growth rate')+
     theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

## Compare time of max growth rate and max OD
```{r}
comp1 <- max.deriv.time %>%
  ungroup() %>%
  dplyr::select(ID2, t_max_deriv, max_deriv) %>%
  left_join(max.od, by='ID2')%>%
  mutate( Serotype=as.factor(Serotype), 
          Serotype= relevel(Serotype, 'deltacps')) %>%
     filter(Background %in% c('15BC','22F') & !grepl("15BC_1\\(", ID2)) 



ggplot(comp1, aes(x=max_od, y=t_max_deriv))+
  geom_point() +
  theme_classic()+
  ggtitle('Time when reach max growth rate vs max density')


ggplot(comp1, aes(x=max_od, y=max_deriv))+
  geom_point() +
  theme_classic()+
  ggtitle('Max growth rate vs max density')

```

```{r}
ggplot(comp1, aes(x=Serotype, y=max_od, color=Background))+
  geom_point() +
  theme_classic()+
  ggtitle('Max density by serotype')+
       theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

```

look at difference between genetic background (how doe affect of serotype vary by background)

```{r}

comp1a <- comp1 %>%
  filter(Serotype %in% c('11A','14', '15BC','16F','18C','19A','23A','24F','3','6C','7C','7F','8','9V')) #serotypes with both backgrounds

mod1 <- lm(max_od ~ Serotype + Background + Serotype * Background ,   data=comp1a)

summary(mod1)

coefs1 <- as.data.frame(coef(mod1)) %>%
  mutate(st= names(coef(mod1)),
         st= gsub('Serotype','',st)) %>%
  rename('beta'= 'coef(mod1)') %>%
  arrange(beta) %>%
  filter(st != '(Intercept)'  & grepl(':Background22F', st) ) %>%
  mutate( index=row_number()) 


ggplot(coefs1, aes(x=index, y=beta, label=st)) +
  geom_point() +
  theme_minimal() +
       theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  geom_text(hjust=0, vjust=0) +
  ggtitle('Interaction of ST and background')

```


## modification 1: first divide by complemented serotype, so center around 1

No intercept or further adjustment for background
```{r}
View(comp1)

complemented_max_od <- comp1 %>%
  mutate(complement = if_else(Background==Serotype,1,0)) %>%
  filter(complement==1) %>%
  group_by(Background) %>%
  summarize(max_od_comp = mean(max_od))

comp2 <- comp1 %>%
  left_join(complemented_max_od, by='Background') %>%
  mutate(adj_max_od = max_od / max_od_comp)


ggplot(comp2, aes(x=Serotype, y=adj_max_od, color=Background)) +
  geom_point() +
  theme_classic()+
         theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))


mod1 <- lm(adj_max_od ~ 1 + Serotype ,   data=comp2)

summary(mod1)


coefs1 <- as.data.frame(coef(mod1)) %>%
  mutate(st= names(coef(mod1)),
         st= gsub('Serotype','',st)) %>%
  rename('beta'= 'coef(mod1)') %>%
  arrange(beta) %>%
  mutate( index=row_number()) %>%
  filter(st != '(Intercept)' & st != 'Background22F' )

ggplot(coefs1, aes(x=index, y=beta, label=st)) +
  geom_point() +
  theme_minimal() +
       theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  geom_text(hjust=0, vjust=0)

```

Allow effect of serotype to vary by background

```{r, fig.width=4, fig.height=3.5}

comp2a <- comp2 %>%
    filter(Serotype %in% c('11A','14', '15BC','16F','18C','19A','23A','24F','3','33F','35F','35B','6C','7C','7F','8','9V')) #serotypes with both backgrounds

mod2 <- lm(adj_max_od ~ 0 + Serotype*Background ,   data=comp2a)

summary(mod2)

mod2.coef <- coef(mod2)

beta2.background22F = mod2.coef['Background22F']

st.eff.back15bc <- cbind.data.frame('beta1' =mod2.coef[-grep('Background', names(mod2.coef))])%>%
  mutate(st =rownames(.)) %>%
  filter(!(st %in% c('Serotype22Fdeltacps', 'Serotype22Fwt')))



st.eff.back22f.marg <-  cbind.data.frame('beta2' =mod2.coef[grep('Background', names(mod2.coef))]) %>%
  mutate(st = gsub(':Background22F','',rownames(.)))

comb.effect <- st.eff.back15bc %>%
  left_join(st.eff.back22f.marg, by='st') %>%
  mutate(beta_back15bc = beta1,
         beta_back22f = beta1 + beta2) %>%
      #   beta_back22f = if_else(st=='Serotype11A',beta2.background22F, beta1 + beta2)) %>%
  arrange(beta_back15bc) %>%
  mutate(order=row_number(),
         st=gsub('Serotype','', st))

ggplot(comb.effect, aes(x=order, y=beta_back15bc, label=st)) +
  geom_point() +
  theme_classic() +
       theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  geom_text(hjust=0, vjust=0)


ggplot(comb.effect, aes(x=beta_back22f, y=beta_back15bc, label=st)) +
  geom_point() +
  theme_classic() +
       theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  geom_text(hjust=0, vjust=0)


ps1 <-read.csv('https://raw.githubusercontent.com/weinbergerlab/GrowthVariation/master/Data/PS%20Composition_SS_final.csv') %>%
  rename(st=Serotype) %>%
  mutate( st= if_else(st=='15B', '15BC', st)
          ) 

comb.effect2 <- comb.effect %>%
  left_join(ps1, by='st') %>%
  mutate(any_gal = if_else(Gal == 1 | GalA==1,1,0),
         NAC = if_else(GlcNAc==1 | GalNAc==1 | ManNAc==1 |  ManNAcA==1 |FucNAc==1 |PneNAc ==1,1,0 ),
         uronic= if_else(GalA==1 | GlcA==1,1,0),
         Gal = ifelse(st=='23A', 1, Gal) ,  #https://pubmed.ncbi.nlm.nih.gov/28837839
         Rha = ifelse(st=='23A', 1, Rha) ,  #https://pubmed.ncbi.nlm.nih.gov/28837839
         Gro = ifelse(st=='23A', 1, Gro) ,  #https://pubmed.ncbi.nlm.nih.gov/28837839
               
         Rha = as.factor(ifelse(st=='7C', 1, Rha)) ,  #https://pubmed.ncbi.nlm.nih.gov/29715685/
         NAC = ifelse(st=='7C', 1, NAC) ,  #https://pubmed.ncbi.nlm.nih.gov/29715685/
         Rha2 = if_else(Rha=='1', 'Yes', 
                        if_else(Rha=='0','No', 'Unk'))

  )

ggplot(comb.effect2, aes(x=beta_back22f, y=beta_back15bc, label=st, color=Rha2)) +
  geom_point() +
  theme_classic() +
       theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  geom_text(hjust=0, vjust=0) +
 ylim(0,1.8)+
  xlim(0,1.8)+
  geom_vline(xintercept=0) +
  geom_hline(yintercept=0) +
  geom_abline(intercept=0, slope=1) +
  xlab('Relative Max OD 22F Background') +
  ylab('Relative Max OD 15B/C Background') +
    scale_color_manual(values=c("#8da0cb", "#fc8d62")) +
   guides(color=guide_legend(title="Rha"))



mod1 <- lm(beta_back15bc ~ beta_back22f + any_gal + Rha, data=comb.effect2)
summary(mod1)

mod1 <- lm(beta_back22f ~ beta_back15bc +  Rha, data=comb.effect2)
summary(mod1)

mod1 <- lm(beta_back15bc ~ beta_back22f + NAC, data=comb.effect2)
summary(mod1)

mod1 <- lm(beta_back15bc ~ beta_back22f + uronic, data=comb.effect2)
summary(mod1)




```

```{r, fig.width=8, fig.height=8}
ggplot(comb.effect2, aes(x=beta_back22f, y=beta_back15bc, label=st, color=Rha2)) +
  geom_point(size=3) +
  theme_classic() +
       theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  geom_text(size=6,hjust=0, vjust=0) +
 ylim(0,1.8)+
  xlim(0,1.8)+
  geom_vline(xintercept=0) +
  geom_hline(yintercept=0) +
  geom_abline(intercept=0, slope=1) +
  xlab('Relative Max OD 22F Background') +
  ylab('Relative Max OD 15B/C Background') +
    scale_color_manual(values=c("#8da0cb", "#fc8d62")) +
   guides(color=guide_legend(title="Rha"))+
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=14,face="bold"))
```


## Max OD-- empirical mean vs rhamnose

```{r}
max.od.st <- max.od %>%
  ungroup() %>%
  filter(Background %in% c('22F','15BC')) %>%
  rename(st=Serotype) %>%
  mutate(Background=paste0('Back',Background)) %>%
  group_by(Background, st) %>%
  summarize(ave_max_od=mean(max_od, N=n()))  %>%
  reshape2::dcast(st ~ Background, value.var='ave_max_od')%>%
  left_join(ps1, by='st') %>%
  mutate(any_gal = if_else(Gal == 1 | GalA==1,1,0),
         NAC = if_else(GlcNAc==1 | GalNAc==1 | ManNAc==1 |  ManNAcA==1 |FucNAc==1 |PneNAc ==1,1,0 ),
         uronic= if_else(GalA==1 | GlcA==1,1,0),
         Gal = ifelse(st=='23A', 1, Gal) ,  #https://pubmed.ncbi.nlm.nih.gov/28837839
         Rha = ifelse(st=='23A', 1, Rha) ,  #https://pubmed.ncbi.nlm.nih.gov/28837839
         Gro = ifelse(st=='23A', 1, Gro) ,  #https://pubmed.ncbi.nlm.nih.gov/28837839
               
         Rha = as.factor(ifelse(st=='7C', 1, Rha)) ,  #https://pubmed.ncbi.nlm.nih.gov/29715685/
         NAC = ifelse(st=='7C', 1, NAC) ,  #https://pubmed.ncbi.nlm.nih.gov/29715685/
         Rha2 = if_else(Rha=='1', 'Yes', 
                        if_else(Rha=='0','No', 'Unk'))

  ) %>%
  filter(!is.na(Back22F) & !is.na(Back15BC))


ggplot(max.od.st, aes(x=Back22F, y=Back15BC, label=st, color=Rha2)) +
  geom_point() +
  theme_classic() +
       theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  geom_text(hjust=0, vjust=0) +
 ylim(0,0.4)+
  xlim(0,0.4)+
  geom_vline(xintercept=0) +
  geom_hline(yintercept=0) +
  geom_abline(intercept=0, slope=1) +
  xlab('Relative Max OD 22F Background') +
  ylab('Relative Max OD 15B/C Background') +
    scale_color_manual(values=c("#8da0cb", "#fc8d62", 'lightgray')) +
   guides(color=guide_legend(title="Rha"))

```

## Bring in carriage and CFR and invasiveness data
```{r, fig.width=8, fig.height=6}
# carr1 <- read.csv('https://raw.githubusercontent.com/weinbergerlab/GrowthVariation/master/Data/carr%20data.csv') %>%
#   rename(st=ST) %>%
#   mutate(st = if_else(st=='6A/C', '6A',st),
#          st = if_else(st %in% c('15B','15C'), '15BC',st))%>%
#   group_by(st) %>%
#   summarize(SLEEMANCARRN=sum(SLEEMANCARRN),
#             NORWAYCARR_PRE=sum(NORWAYCARR_PRE),
#             MASSCARR01=sum(MASSCARR01),
#             GREECECARRN=sum(GREECECARRN))

#from LÃ¸chen A, Truscott JE, Croucher NJ.PLOS COMP Biol 2022
carr1 <- read.csv('https://raw.githubusercontent.com/nickjcroucher/progressionEstimation/main/data-raw/S_pneumoniae_infant_serotype.csv') %>%
  rename(st=type) %>%
  mutate(st = if_else(st=='15B/C','15BC', st),
         period=substring(study, first = regexpr("\\.", study) + 1),
         pop=sub("\\..*", "", study) 
  )


#fill in missing values
carr.fill1  <- carr1  %>%
  ungroup() %>%
  dplyr::select(carriage, carriage_samples,period, pop, st) %>%
  reshape2::melt(. ,id.vars=c('period','pop','st')) %>%
  reshape2::dcast(. , st + pop ~ period + variable , value.var='value') %>%
  mutate( pre.PCV_carriage = ifelse( is.na(pre.PCV_carriage) & pop %in% c('Alabama','Atlanta','Bogota', 'Caracas','Czech','E','Goroka','Morocco','Netherlands','Ontario','Portugal'), 0, pre.PCV_carriage ),
          post.PCV7_carriage = ifelse( is.na(post.PCV7_carriage) & pop %in% c('Atlanta','Barcelona','Bogota','France','Massachusetts','Navajo','Netherlands'), 0, post.PCV7_carriage ),
           post.PCV10_carriage = ifelse( is.na(post.PCV10_carriage) & pop %in% c('Netherlands'), 0, post.PCV10_carriage ),
           post.PCV13_carriage = ifelse( is.na(post.PCV13_carriage) & pop %in% c('France'), 0, post.PCV13_carriage ),
          change.post.pcv7 = ((post.PCV7_carriage+0.5)/post.PCV7_carriage_samples) /  ((pre.PCV_carriage+0.5)/pre.PCV_carriage_samples),
          change.post.pcv13.vs.7 = (post.PCV13_carriage+0.5)/post.PCV13_carriage_samples /  ((post.PCV7_carriage+0.5)/post.PCV7_carriage_samples),
          change.post.pcv10 = ((post.PCV10_carriage+0.5)/post.PCV10_carriage_samples)  / ((pre.PCV_carriage+0.5)/pre.PCV_carriage_samples)

                  )

carr_filled2 <- carr.fill1 %>%
  dplyr::select(st, pop, post.PCV10_carriage,post.PCV13_carriage,post.PCV7_carriage,pre.PCV_carriage ) %>%
  reshape2::melt(., id.vars=c('pop','st')) %>%
  rename(period=variable, carriage=value) %>%
  group_by(pop,period) %>%
  mutate(tot_carrN=sum(carriage) , carr_prop=carriage/tot_carrN,
         period= gsub('_carriage','',period),
   # period= ifelse(period=='W.pre.PCV','pre.PCV',period),
         vt=if_else(period=='post.PCV7' & st %in% c('4','6B','9V','14','18C','19F','23F'),1,
                 if_else(period=='post.PCV10' & st %in% c('4','6B','9V','14','18C','19F','23F','1','5','7F'),1,
                 if_else(period=='post.PCV13' & st %in% c('4','6B','9V','14','18C','19F','23F','1','3','5','6A','7F','19A'),1,0)))) %>%
  filter(tot_carrN >0 & !grepl('change', period)) 

carr_change <- carr.fill1 %>%
  reshape2::melt(., id.vars=c('pop','st')) %>%
   filter(pop %in% c('Atlanta', 'Bogota', 'France', 'Netherlands')) %>%
  rename(period=variable, carriage=value) %>%
  group_by(pop,period) %>%
  mutate(tot_carrN=sum(carriage, na.rm=T)) %>%
  filter(tot_carrN >0 & grepl('change', period)) %>%
  rename(change_carr=carriage) %>%
  dplyr::select(st,pop, period, change_carr) %>%
  mutate(period = gsub('change.','', period))



carr2 <- carr1 %>%
  dplyr::select(-carriage) %>%
  right_join(carr_filled2, by=c('st','pop','period')) %>%

  left_join(comb.effect2, by='st') %>%
  ungroup() %>%
  group_by(pop, period) %>%
  mutate(carr_prop= carriage/sum(carriage),
         ipd_prop=disease/sum(disease),
         case_carr= (disease+0.5)/(carriage+0.5)
  )


## Carriage
ggplot(carr2, aes(x=beta_back22f, y=carr_prop , label=st, color=as.factor(vt))) +
  geom_point() +
   geom_text() +
  facet_wrap(~pop+period, scales='free') +
  theme_classic()

ggplot(carr2, aes(x=beta_back15bc, y=carr_prop , label=st, color=as.factor(vt))) +
  geom_point() +
   geom_text() +
  facet_wrap(~pop+period, scales='free') +
  theme_classic()

##case carrier
ggplot(carr2, aes(x=beta_back22f, y=case_carr , label=st, color=as.factor(vt))) +
  geom_point() +
   geom_text() +
  facet_wrap(~study, scales='free') +
  theme_classic()

ggplot(carr2, aes(x=beta_back15bc, y=case_carr , label=st, color=as.factor(vt))) +
  geom_point() +
   geom_text() +
    facet_wrap(~study, scales='free') +
  theme_classic()


#carriage change
carr_change2 <- carr_change  %>%
  left_join(comb.effect2, by='st') %>%
  ungroup() %>%
  mutate( vt=if_else(period=='post.pcv7' & st %in% c('4','6B','9V','14','18C','19F','23F'),1,
                 if_else(period=='post.pcv13.vs.7' & st %in% c('1','5','7F'),1,
                 if_else(period=='post.PCV13' & st %in% c('4','6B','9V','14','18C','19F','23F','1','3','5','6A','7F','19A'),1,0)))
          )

ggplot(carr_change2, aes(x=beta_back15bc, y=change_carr , label=st, color=as.factor(vt))) +
  geom_point() +
   geom_text() +
  facet_wrap(~pop+period, scales='free') +
  theme_classic()

ggplot(carr_change2, aes(x=beta_back22f, y=change_carr , label=st, color=as.factor(vt))) +
  geom_point() +
   geom_text() +
  facet_wrap(~pop+period, scales='free') +
  theme_classic()



```



```{r}
##Carriage
mod1a <- glm.nb(carriage ~ beta_back15bc +study + vt , data=carr2)
summary(mod1a)

mod1b <- glm.nb(carriage ~ beta_back22f +study +vt, data=carr2)
summary(mod1b)

#IPD
mod2 <- glm.nb(disease ~ beta_back15bc +study + vt , data=carr2)
summary(mod2)

mod2 <- glm(disease ~ beta_back22f +study + vt , data=carr2, family='quasipoisson')
summary(mod2)


#case:carrier ratio
mod3 <- lm(case_carr ~ beta_back15bc +study + vt , data=carr2)
summary(mod3)

carr2$log_case_carr=log(carr2$case_carr)
mod3 <- lm(log_case_carr ~ beta_back22f +study + vt , data=carr2)
summary(mod3)

```


```{r}

```



carriage, invasiveness vs rhamnose or others
```{r}

carr_ps1 <- carr_filled2 %>%
  left_join(ps1, by='st') %>%
  mutate(period = as.factor(period),
         period=relevel(period,'pre.PCV'))

mod1 <- glm.nb(carriage ~ Rha +GlcA +pop + period +vt, data=carr_ps1)
summary(mod1)

mod1a <- glm.nb(carriage ~ Rha + Rha*period + GlcA +pop + period +vt, data=carr_ps1)
summary(mod1a)


mod1 <- glm.nb(carriage ~ GlcNAc +pop+period +vt, data=carr_ps1)
summary(mod1)

```

regular NegBin
```{r}

carr_ps2 <- carr_ps1 %>%
  filter(!is.na(GlcA)) %>%
  mutate(
         period=as.factor(period),
         period = relevel(period, ref='pre.PCV'))


ggplot(carr_ps2, aes(x=Rha, y=carriage, col=vt))+
  geom_point() +
  theme_classic()+
    facet_wrap(~period+pop, scales='free')

mod1 <- glm.nb(carriage ~  vt + GlcA + GalA+ GlcNAc + GalNAc+Rha + pop +period,  data=carr_ps2)

summary(mod1)

mod2 <- glm.nb(carriage ~  vt + Rha + period + Rha*period ,  data=carr_ps2)

summary(mod2)


```


what if we do hold out (for PCV13)?
```{r}
carr_ps2 <- carr_ps1 %>%
  filter(!is.na(GlcA)) %>%
 mutate( carr_nonpcv13 = ifelse(period != 'post.PCV13',carriage, NA_real_))

mod1 <- glm.nb(carr_nonpcv13 ~  vt + GlcA + GalA+ GlcNAc + GalNAc+Rha ,  data=carr_ps2)

summary(mod1)

predict.holdout = carr_ps2 %>%
  ungroup() %>%
  mutate(pred1 = predict(mod1, type='response', newdata=carr_ps2)) %>%
  filter(is.na(carr_nonpcv13))

cor(predict.holdout$pred1, predict.holdout$carr_prop)

ggplot(predict.holdout, aes(x=pred1, y=carriage, label=st, col=vt)) +
  #geom_point() +
  theme_classic()+
  geom_text()
```

what if we do hold out (for PCV13), predict post-PCV7 based on post-PCV13?
```{r}
carr_ps2 <- carr_ps1 %>%
  filter(!is.na(GlcA)) %>%
 mutate( carr_nonpcv13 = ifelse(period != 'post.PCV13',carriage, NA_real_)) %>%
  ungroup() %>%
  group_by(period, st) %>%
  mutate(ave_st_previous= mean(carr_prop, na.rm=T),
         period=as.character(period),
        period.match = if_else(period %in% c('post.PCV7'), 'pre.PCV', if_else(period %in% c('post.PCV10','post.PCV13'), 'post.PCV7', NA_character_ )
        )
  )

carr_match <- carr_ps2 %>%
  ungroup() %>%
  dplyr::select(st, period,ave_st_previous)

carr_ps2 <- carr_ps2 %>%
  dplyr::select(-period,-ave_st_previous)

carr_ps3 <- carr_ps2 %>%
  left_join(carr_match, by=c('st'='st', 'period.match'='period')) %>%
  mutate(sqrt_ave_st_previous=sqrt(ave_st_previous))

mod1 <- glm.nb(carr_nonpcv13 ~  vt + GlcA + GalA+ GlcNAc + GalNAc+Rha + sqrt_ave_st_previous,  data=carr_ps3)

summary(mod1)

predict.holdout = carr_ps3 %>%
  ungroup() %>%
  mutate(pred1 = predict(mod1, type='response', newdata=carr_ps3)) %>%
  filter(is.na(carr_nonpcv13))

cor(predict.holdout$pred1, predict.holdout$carr_prop)

ggplot(predict.holdout, aes(x=pred1, y=carriage, label=st, col=vt)) +
  #geom_point() +
  theme_classic()+
  geom_text()
```

Now repeat but leave out the PS structures...it actually does better just with prevalence

```{r}
mod2 <- glm.nb(carr_nonpcv13 ~  vt + sqrt_ave_st_previous,  data=carr_ps3)

summary(mod2)

predict.holdout = carr_ps3 %>%
  ungroup() %>%
  mutate(pred1 = predict(mod2, type='response', newdata=carr_ps3)) %>%
  filter(is.na(carr_nonpcv13))

cor(predict.holdout$pred1, predict.holdout$carr_prop)

ggplot(predict.holdout, aes(x=pred1, y=carriage, label=st, col=vt)) +
  #geom_point() +
  theme_classic()+
  geom_text()
```


lasso
```{r}
library(mpath)

#PCV
mod1.reg <- cv.glmregNB(carriage ~ study + vt + GlcA + GalA+ GlcNAc + GalNAc+Rha , alpha=0.99, data=carr_ps2,parallel=T)
optim.lambda <- mod1.reg$lambda.optim

plot(mod1.reg)
abline(v=log(optim.lambda))
summary(mod1.reg)



mod2.reg <- glmregNB(carriage ~ study + vt + GlcA + GalA+ GlcNAc + GalNAc+Rha , lambda=exp(-3), alpha=0.99, data=carr_ps2,parallel=T)

mod2.reg$beta
```

## Look at multiple transformants


reshape to long format
```{r}
e1.m <- reshape2::melt(e1, id.vars=c('ID','Serotype','Background','Clone_N','Rep')) %>%
  arrange(ID,Background, Serotype, Clone_N,Rep, value) %>%
  group_by(ID,Background, Serotype, Clone_N,Rep) %>%
  mutate( index= row_number() -1,  
          t= index/2,
          t0=min(value, na.rm=T),
          OD= value - t0,
          ID2 = paste(ID, Rep, sep='_'),
          Serotype= if_else(Serotype=='8C','18C',Serotype ),
          Serotype= if_else(Serotype=='15B/C','15BC',Serotype ),
          Serotype= if_else(Serotype=='9A','19A',Serotype ),
          Clone_N=as.factor(Clone_N))  %>%
  filter(t<=24 & Background %in% c('15BC','22F')) %>%
  ungroup() 
  
```


Group by Background, color by Serotype

```{r, fig.width=5, fig.height=4}
e1.m %>%
  filter(Serotype=='8') %>%
 ggplot( aes(x=t, y=OD, group=interaction(Clone_N, Rep), color=Clone_N)) +
  geom_line()+
  theme_classic() + 
  scale_color_manual(values=c("#1b9e77", "#d95f02")) +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=14,face="bold"))+
  theme(legend.position="none")
#+
 # facet_wrap(~ID, nrow = 1)

#ggplotly(p1)
```



