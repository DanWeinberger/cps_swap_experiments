---
title: "Growth data"
author: "Dan Weinberger"
date: '2023-03-24'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(dplyr)
library(ggplot2)
library(purrr)
library(readxl)
library(patchwork)
library(reshape2)
library(plotly)
library(MASS)
```

Read in the data

```{r}
a1 <- read_xlsx('./Data/Growth_Curve_Summary_Data_V2.xlsx') %>%
  mutate(Background = if_else(Serotype %in% c('22Fdeltacps','22Fwt'), '22F', Background))
```

```{r}
names(a1)
```

reshape to long format
```{r}
a1.m <- reshape2::melt(a1, id.vars=c('ID','Serotype','Background','Clone_N','Rep')) %>%
  arrange(ID,Background, Serotype, Clone_N,Rep, value) %>%
  group_by(ID,Background, Serotype, Clone_N,Rep) %>%
  mutate( index= row_number() -1,  
          t= index/2,
          t0=min(value, na.rm=T),
          OD= value - t0,
          ID2 = paste(ID, Rep, sep='_'),
          Serotype= if_else(Serotype=='8C','18C',Serotype ),
          Serotype= if_else(Serotype=='15B/C','15BC',Serotype ),
          Serotype= if_else(Serotype=='9A','19A',Serotype ))  %>%
  filter(t<=20 & Background %in% c('15BC','22F')) %>%
  ungroup()
```


Group by Background, color by Serotype

```{r}
p1 <- ggplot(a1.m, aes(x=t, y=OD, group=ID2, color=Serotype)) +
  geom_line()+
  theme_classic() +
  facet_wrap(~Background)

p1
ggplotly(p1)
```
Group by Serotype, color by Background

```{r}
p1 <- ggplot(a1.m, aes(x=t, y=OD, group=ID2, color=Background)) +
  geom_line()+
  theme_classic() +
  facet_wrap(~Serotype)

p1
```

## Calculate Max OD

```{r}
max.od <- a1.m %>%
    group_by(ID2,Background, Serotype, Clone_N,Rep) %>%
    summarize( max_od=max(OD, na.rm=T)) %>%
  mutate(Clone_N=as.factor(Clone_N)) 

max.od
```

```{r}
ggplot(max.od , aes(x=Serotype, y=max_od,color=Background, shape=Clone_N))+
  geom_point(alpha=0.5)+
  theme_classic()+
       theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```



Smooth with a spline

```{r}
smooth.func<-function(x, cont.correct){
  smooth.mod<-smooth.spline((x[!is.na(x)]), spar=0.5)
  ODsm= smooth.mod$y
  deriv = predict(smooth.mod, deriv=1)$y
  deriv2 = predict(smooth.mod, deriv=2)$y

  out.df= cbind.data.frame('ODsm'=ODsm,'deriv'=deriv,'deriv2'=deriv2)
  return(out.df)
}


a2 <- a1.m %>%
    group_by(ID,Background, Serotype, Clone_N,Rep) %>%
  filter(!is.na(OD)) %>%
    mutate(smoothvals = smooth.func(OD) ) %>%
tidyr::unpack(., cols=smoothvals)


p1 <- ggplot(a1.m, aes(x=t, y=OD, group=ID2, color=Background)) +
  geom_line()+
  geom_line(data=a2,aes(x=t, y=ODsm, group=ID2, color='gray'))+
  theme_classic() +
  facet_wrap(~Serotype)

p1
```

Plot of smoothed values
```{r}
p1 <- ggplot(a2, aes(x=t, y=(ODsm), group=ID2, color=Serotype)) +
  geom_line()+
  theme_classic() +
  facet_wrap(~Background)+
  ggtitle('OD')

ggplotly(p1)
```

Plot of derivatives. When derivative is at max, this shows when growth rate maxes out
```{r}
p2 <- ggplot(a2, aes(x=t, y=deriv, group=ID2, color=Serotype)) +
  geom_line()+
  theme_classic() +
  facet_wrap(~Background)+
  ggtitle('Growth rate')

ggplotly(p2)
```


Plot of derivatives. When derivative is at max, this shows when growth rate maxes out
```{r}
p3 <- ggplot(a2, aes(x=t, y=deriv2, group=ID2, color=Serotype)) +
  geom_line()+
  theme_classic() +
  facet_wrap(~Background)+
  ggtitle('Change in growth rate')

ggplotly(p3)
```

```{r}
p1/p2
```

At what time point does max growth occur?
```{r}
max.deriv.time <- a2 %>%
    group_by(ID2,Background, Serotype, Clone_N,Rep) %>%
   summarize( t_max_deriv = t[which(deriv==max(deriv, na.rm=T)) ], max_deriv=max(deriv, na.rm=T) ) %>%
  mutate(label= paste(Background, Serotype ))
  max.deriv.time
  
  ggplot(max.deriv.time , aes(x=label, y=t_max_deriv))+
    geom_jitter(width=0.1, height=0, alpha=0.5)+
    theme_classic() +
    ylab('Time of max growth rate')+
     theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

## Compare time of max growth rate and max OD
```{r}
comp1 <- max.deriv.time %>%
  ungroup() %>%
  dplyr::select(ID2, t_max_deriv, max_deriv) %>%
  left_join(max.od, by='ID2')%>%
  mutate( Serotype=as.factor(Serotype), 
          Serotype= relevel(Serotype, '15BCdeltacps'))


ggplot(comp1, aes(x=max_od, y=t_max_deriv))+
  geom_point() +
  theme_classic()+
  ggtitle('Time when reach max growth rate vs max density')


ggplot(comp1, aes(x=max_od, y=max_deriv))+
  geom_point() +
  theme_classic()+
  ggtitle('Max growth rate vs max density')

```

```{r}
ggplot(comp1, aes(x=Serotype, y=max_od, color=Background))+
  geom_point() +
  theme_classic()+
  ggtitle('Max density by serotype')+
       theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

```

look at difference between genetic background (how doe affect of serotype vary by background)

```{r}

comp1a <- comp1 %>%
  filter(Serotype %in% c('11A','14', '15BC','16F','18C','19A','23A','24F','3','6C','7C','7F','8','9V')) #serotypes with both backgrounds

mod1 <- lm(max_od ~ Serotype + Background + Serotype * Background ,   data=comp1a)

summary(mod1)

coefs1 <- as.data.frame(coef(mod1)) %>%
  mutate(st= names(coef(mod1)),
         st= gsub('Serotype','',st)) %>%
  rename('beta'= 'coef(mod1)') %>%
  arrange(beta) %>%
  filter(st != '(Intercept)'  & grepl(':Background22F', st) ) %>%
  mutate( index=row_number()) 


ggplot(coefs1, aes(x=index, y=beta, label=st)) +
  geom_point() +
  theme_minimal() +
       theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  geom_text(hjust=0, vjust=0) +
  ggtitle('Interaction of ST and background')

```


## modification 1: first divide by complemented serotype, so center around 1

No intercept or further adjustment for background
```{r}
View(comp1)

complemented_max_od <- comp1 %>%
  mutate(complement = if_else(Background==Serotype,1,0)) %>%
  filter(complement==1) %>%
  group_by(Background) %>%
  summarize(max_od_comp = mean(max_od))

comp2 <- comp1 %>%
  left_join(complemented_max_od, by='Background') %>%
  mutate(adj_max_od = max_od / max_od_comp)


ggplot(comp2, aes(x=Serotype, y=adj_max_od, color=Background)) +
  geom_point() +
  theme_classic()+
         theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))


mod1 <- lm(adj_max_od ~ 1 + Serotype ,   data=comp2)

summary(mod1)


coefs1 <- as.data.frame(coef(mod1)) %>%
  mutate(st= names(coef(mod1)),
         st= gsub('Serotype','',st)) %>%
  rename('beta'= 'coef(mod1)') %>%
  arrange(beta) %>%
  mutate( index=row_number()) %>%
  filter(st != '(Intercept)' & st != 'Background22F' )

ggplot(coefs1, aes(x=index, y=beta, label=st)) +
  geom_point() +
  theme_minimal() +
       theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  geom_text(hjust=0, vjust=0)

```

Allow effect of serotype to vary by background

```{r}

comp2a <- comp2 %>%
    filter(Serotype %in% c('11A','14', '15BC','16F','18C','19A','23A','24F','3','6C','7C','7F','8','9V')) #serotypes with both backgrounds

mod2 <- lm(adj_max_od ~ 0 + Serotype*Background ,   data=comp2a)

summary(mod2)

mod2.coef <- coef(mod2)

st.eff.back15bc <- cbind.data.frame('beta1' =mod2.coef[-grep('Background', names(mod2.coef))])%>%
  mutate(st =rownames(.) ) %>%
  filter(!(st %in% c('Serotype22Fdeltacps', 'Serotype22Fwt')))



st.eff.back22f.marg <-  cbind.data.frame('beta2' =mod2.coef[grep('Background', names(mod2.coef))]) %>%
  mutate(st = gsub(':Background22F','',rownames(.)))

comb.effect <- st.eff.back15bc %>%
  left_join(st.eff.back22f.marg, by='st') %>%
  mutate(beta_back15bc = beta1,
         beta_back22f = beta1 + beta2) %>%
  arrange(beta_back15bc) %>%
  mutate(order=row_number(),
         st=gsub('Serotype','', st))

ggplot(comb.effect, aes(x=order, y=beta_back15bc, label=st)) +
  geom_point() +
  theme_classic() +
       theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  geom_text(hjust=0, vjust=0)


ggplot(comb.effect, aes(x=beta_back22f, y=beta_back15bc, label=st)) +
  geom_point() +
  theme_classic() +
       theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  geom_text(hjust=0, vjust=0)


ps1 <-read.csv('https://raw.githubusercontent.com/weinbergerlab/GrowthVariation/master/Data/PS%20Composition_SS_final.csv') %>%
  rename(st=Serotype) %>%
  mutate( st= if_else(st=='15B', '15BC', st)
          ) 

comb.effect2 <- comb.effect %>%
  left_join(ps1, by='st') %>%
  mutate(any_gal = if_else(Gal == 1 | GalA==1,1,0),
         NAC = if_else(GlcNAc==1 | GalNAc==1 | ManNAc==1 |  ManNAcA==1 |FucNAc==1 |PneNAc ==1,1,0 ),
         uronic= if_else(GalA==1 | GlcA==1,1,0),
         Gal = ifelse(st=='23A', 1, Gal) ,  #https://pubmed.ncbi.nlm.nih.gov/28837839
         Rha = ifelse(st=='23A', 1, Rha) ,  #https://pubmed.ncbi.nlm.nih.gov/28837839
         Gro = ifelse(st=='23A', 1, Gro) ,  #https://pubmed.ncbi.nlm.nih.gov/28837839
               
         Rha = ifelse(st=='7C', 1, Rha) ,  #https://pubmed.ncbi.nlm.nih.gov/29715685/
         NAC = ifelse(st=='7C', 1, NAC) ,  #https://pubmed.ncbi.nlm.nih.gov/29715685/
         

  )

ggplot(comb.effect2, aes(x=beta_back22f, y=beta_back15bc, label=st, color=Rha)) +
  geom_point() +
  theme_classic() +
       theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  geom_text(hjust=0, vjust=0) +
 ylim(0,1.8)+
  xlim(0,1.8)+
  geom_vline(xintercept=0) +
  geom_hline(yintercept=0) +
  geom_abline(intercept=0, slope=1)


mod1 <- lm(beta_back15bc ~ beta_back22f + any_gal + Rha, data=comb.effect2)
summary(mod1)

mod1 <- lm(beta_back15bc ~ beta_back22f +  Rha, data=comb.effect2)
summary(mod1)

mod1 <- lm(beta_back15bc ~ beta_back22f + NAC, data=comb.effect2)
summary(mod1)

mod1 <- lm(beta_back15bc ~ beta_back22f + uronic, data=comb.effect2)
summary(mod1)




```

## Bring in carriage and CFR and invasiveness data
```{r}
# carr1 <- read.csv('https://raw.githubusercontent.com/weinbergerlab/GrowthVariation/master/Data/carr%20data.csv') %>%
#   rename(st=ST) %>%
#   mutate(st = if_else(st=='6A/C', '6A',st),
#          st = if_else(st %in% c('15B','15C'), '15BC',st))%>%
#   group_by(st) %>%
#   summarize(SLEEMANCARRN=sum(SLEEMANCARRN),
#             NORWAYCARR_PRE=sum(NORWAYCARR_PRE),
#             MASSCARR01=sum(MASSCARR01),
#             GREECECARRN=sum(GREECECARRN))

#from LÃ¸chen A, Truscott JE, Croucher NJ.PLOS COMP Biol 2022
carr1 <- read.csv('https://raw.githubusercontent.com/nickjcroucher/progressionEstimation/main/data-raw/S_pneumoniae_infant_serotype.csv') %>%
  rename(st=type) %>%
  mutate(st = if_else(st=='15B/C','15BC', st),
         post_period =sub("^[^.]*\\.\\s*", "", study),
    post_period= if_else(post_period=='W.pre.PCV','pre.PCV',post_period),
         vt=if_else(post_period=='post.PCV7' & st %in% c('4','6B','9V','14','18C','19F','23F'),1,
                 if_else(post_period=='post.PCV10' & st %in% c('4','6B','9V','14','18C','19F','23F','1','5','7F'),1,
                 if_else(post_period=='post.PCV13' & st %in% c('4','6B','9V','14','18C','19F','23F','1','3','5','6A','7F','19A'),1,0)))) 

carr2 <- comb.effect2 %>%
  right_join(carr1, by='st') %>%
  group_by(study) %>%
  mutate(carr_prop= carriage/sum(carriage),
         ipd_prop=disease/sum(disease),
         case_carr= (disease+0.5)/(carriage+0.5)
  )

## Carriage
ggplot(carr2, aes(x=beta_back22f, y=carr_prop , label=st)) +
  geom_point() +
   geom_text() +
  theme_classic()

ggplot(carr2, aes(x=beta_back15bc, y=carr_prop , label=st)) +
  geom_point() +
   geom_text() +
  theme_classic()

##case carrier
ggplot(carr2, aes(x=beta_back22f, y=case_carr , label=st)) +
  geom_point() +
   geom_text() +
  theme_classic()

ggplot(carr2, aes(x=beta_back15bc, y=case_carr , label=st)) +
  geom_point() +
   geom_text() +
  theme_classic()
```


```{r}
##Carriage
mod1a <- glm.nb(carriage ~ beta_back15bc +study + vt , data=carr2)
summary(mod1a)

mod1b <- glm.nb(carriage ~ beta_back22f +study +vt, data=carr2)
summary(mod1b)

#IPD
mod2 <- glm.nb(disease ~ beta_back15bc +study + vt , data=carr2)
summary(mod2)

mod2 <- glm.nb(disease ~ beta_back22f +study + vt , data=carr2)
summary(mod2)


#case:carrier ratio
mod3 <- lm(case_carr ~ beta_back15bc +study + vt , data=carr2)
summary(mod3)

mod3 <- lm(case_carr ~ beta_back22f +study + vt , data=carr2)
summary(mod3)

```
carriage, invasiveness vs rhamnose or others
```{r}

carr_ps1 <- carr1 %>%
  left_join(ps1, by='st')

mod1 <- glm.nb(carriage ~ Rha +GlcA +study +vt, data=carr_ps1)
summary(mod1)


mod1 <- glm.nb(carriage ~ GlcNAc +study +vt, data=carr_ps1)
summary(mod1)

```

regular NegBin
```{r}

carr_ps2 <- carr_ps1 %>%
  filter(!is.na(GlcA))

mod1 <- glm.nb(carriage ~ study + vt + GlcA + GalA+ GlcNAc + GalNAc+Rha ,  data=carr_ps2)

summary(mod1)
```


what if we do hold out (for PCV13)?
```{r}
carr_ps2 <- carr_ps1 %>%
  filter(!is.na(GlcA)) %>%
 mutate( carr_nonpcv13 = ifelse(post_period != 'post.PCV13',carriage, NA_real_))

mod1 <- glm.nb(carr_nonpcv13 ~  vt + GlcA + GalA+ GlcNAc + GalNAc+Rha ,  data=carr_ps2)

summary(mod1)

predict.holdout = carr_ps2 %>%
  mutate(pred1 = predict(mod1, type='response', newdata=carr_ps2)) %>%
  filter(is.na(carr_nonpcv13))

ggplot(predict.holdout, aes(x=pred1, y=carriage, label=st)) +
  #geom_point() +
  theme_classic()+
  geom_text()
```


lasso
```{r}
library(mpath)

#PCV
mod1.reg <- cv.glmregNB(carriage ~ study + vt + GlcA + GalA+ GlcNAc + GalNAc+Rha , alpha=0.99, data=carr_ps2,parallel=T)
optim.lambda <- mod1.reg$lambda.optim

plot(mod1.reg)
abline(v=log(optim.lambda))
summary(mod1.reg)



mod2.reg <- glmregNB(carriage ~ study + vt + GlcA + GalA+ GlcNAc + GalNAc+Rha , lambda=exp(-3), alpha=0.99, data=carr_ps2,parallel=T)

mod2.reg$beta
```





